# Phase 4: Integration & Flow 개발 로그

**날짜**: 2026-02-03
**Phase**: Phase 4 - Integration & Flow
**상태**: 완료

## 개요
모든 시스템 통합, 완전한 게임 플로우 구현, 세이브/로드 시스템 구축.

## 구현 내용

### 1. 게임 컨트롤러 (lib/app/game_controller.dart)
- `GameControllerState`: 전체 게임 상태 관리
- `GameControllerNotifier`: Riverpod StateNotifier
- 화면 전환: mainMenu, playing, gameOver, victory
- 게임 시작/재시작/일시정지/재개
- 인벤토리 토글
- 보스전 상태 관리
- Provider를 통한 인벤토리/게임상태 연동

### 2. 세이브 매니저 (lib/data/services/save_manager.dart)
- `SaveData`: 세이브 데이터 모델
  - 층, 하트, 체력, 점수, 시간
  - 인벤토리 아이템, 장비
  - JSON 직렬화/역직렬화
- `SaveManager`: SharedPreferences 기반 저장
  - 세이브/로드/삭제
  - 세이브 데이터 존재 확인
- `GameSettings`: 게임 설정
  - BGM/SFX 볼륨
  - 진동, 데미지 숫자 표시

### 3. 메인 앱 (lib/app/arcana_app.dart)
- `ArcanaApp`: MaterialApp 설정
- `ArcanaHome`: 메인 화면 라우팅
- 화면 전환 로직
- 오버레이 관리 (일시정지, 인벤토리)
- `_GameplayWidget`: 게임 화면 + HUD 통합
- `_HeartsDisplay`: 3색 하트 표시

### 4. main.dart 업데이트
- 화면 방향 고정 (가로)
- 전체 화면 모드
- SaveManager 초기화
- AudioManager 초기화

### 5. HUD 통합
- 하트 표시 (Body/Mind/Soul 색상)
- 현재 층 표시
- 점수 표시
- 골드 표시
- 인벤토리 버튼
- 일시정지 버튼
- 보스 체력바 (보스전 시)

## 게임 플로우

```
┌──────────────┐
│  Main Menu   │
│              │
│ [새 게임]    │──────────┐
│ [이어하기]   │          │
└──────────────┘          ▼
                   ┌──────────────┐
                   │   Playing    │◄─────┐
                   │              │      │
                   │  [일시정지]  │──┐   │
                   │  [인벤토리]  │  │   │
                   └──────────────┘  │   │
                          │         │   │
                    Death │   Pause │   │
                          ▼         ▼   │
                   ┌──────────┐  ┌──────────┐
                   │ GameOver │  │  Pause   │
                   │          │  │  Menu    │
                   │[재시작]  │──┼─[계속]───┘
                   │[메인메뉴]│  │ [재시작]
                   └──────────┘  │ [메인메뉴]
                          │      └──────────┘
                    Boss  │           │
                   Clear  ▼           │
                   ┌──────────────┐    │
                   │   Victory    │    │
                   │              │    │
                   │ [새 게임]    │────┘
                   │ [메인메뉴]   │
                   └──────────────┘
```

## 기술적 결정

### 상태 관리 구조
- `GameControllerProvider`: 전체 게임 플로우
- `GameStateProvider`: 점수, 통계
- `InventoryProvider`: 인벤토리, 장비
- 3개 Provider 협력으로 관심사 분리

### 세이브 시스템
- SharedPreferences 사용 (로컬 저장)
- JSON 직렬화로 유연한 데이터 구조
- 설정과 세이브 데이터 분리 저장

### 화면 전환
- Stack 기반 오버레이 방식
- 게임 화면 위에 일시정지/인벤토리 표시
- 상태 기반 조건부 렌더링

## 코드 품질
- `flutter analyze`: 통과 (info 3건 - 무시 가능)
- 린트 규칙 준수

## 파일 목록

### 신규 생성
- lib/app/arcana_app.dart
- lib/app/game_controller.dart
- lib/data/services/save_manager.dart

### 수정
- lib/main.dart
- test/widget_test.dart

## 프로젝트 최종 구조

```
lib/
├── app/
│   ├── arcana_app.dart         # 메인 앱 위젯
│   └── game_controller.dart    # 게임 컨트롤러
├── config/
│   └── constants.dart          # 게임 상수
├── data/
│   ├── model/
│   │   ├── item.dart           # 아이템 모델
│   │   ├── enemy_data.dart     # 적 데이터
│   │   └── room.dart           # 방/던전 모델
│   └── services/
│       └── save_manager.dart   # 세이브/로드
├── game/
│   ├── arcana_game.dart        # Flame 게임
│   ├── characters/
│   │   └── player.dart         # 플레이어
│   ├── enemies/
│   │   ├── base_enemy.dart     # 적 베이스
│   │   ├── dummy_enemy.dart    # 테스트 적
│   │   ├── slime_enemy.dart    # 슬라임/고블린
│   │   └── boss_slime.dart     # 보스
│   ├── behaviors/
│   │   └── enemy_ai.dart       # AI 시스템
│   ├── decorations/
│   │   └── dropped_item.dart   # 드롭 아이템
│   ├── interface/
│   │   └── game_hud.dart       # 게임 HUD
│   ├── managers/
│   │   ├── dungeon_manager.dart # 던전 관리
│   │   └── audio_manager.dart   # 오디오 관리
│   └── maps/
│       ├── game_map.dart        # 기본 맵
│       ├── dungeon_generator.dart # 던전 생성
│       └── room_component.dart  # 방 컴포넌트
├── providers/
│   ├── game_state_provider.dart # 게임 상태
│   └── inventory_provider.dart  # 인벤토리
├── ui/
│   ├── screens/
│   │   ├── game_screen.dart     # 게임 화면
│   │   ├── main_menu_screen.dart # 메인 메뉴
│   │   ├── pause_menu.dart      # 일시정지
│   │   ├── inventory_screen.dart # 인벤토리
│   │   ├── game_over_screen.dart # 게임오버
│   │   └── victory_screen.dart  # 승리
│   └── widgets/
│       ├── item_slot.dart       # 아이템 슬롯
│       ├── boss_health_bar.dart # 보스 체력바
│       └── minimap.dart         # 미니맵
└── main.dart                    # 앱 진입점
```

## 완료된 전체 Phase 요약

| Phase | 내용 | 상태 |
|-------|------|------|
| Phase 0 | 프로젝트 설정 | ✅ |
| Phase 1 | 기본 프로토타입 | ✅ |
| Phase 2 | Core Loop | ✅ |
| Phase 3 | Content & Polish | ✅ |
| Phase 4 | Integration & Flow | ✅ |

## 다음 단계 제안

### 즉시 가능
- 실제 테스트 플레이
- 버그 수정
- 밸런스 조정

### 추가 개발
- 스프라이트 애니메이션
- 실제 오디오 파일 추가
- 더 많은 적/아이템
- Chapter 2, 3 콘텐츠
- Firebase 연동 (랭킹, 클라우드 세이브)

---
*Generated by Claude Agent Protocol v1.0*
