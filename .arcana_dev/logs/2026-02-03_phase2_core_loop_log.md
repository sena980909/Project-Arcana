# Phase 2: Core Loop 개발 로그

**날짜**: 2026-02-03
**Phase**: Phase 2 - Core Loop
**상태**: 완료

## 개요
Phase 1의 기초 프로토타입 위에 핵심 게임 루프를 구현. 적 AI, 아이템 드롭, 인벤토리 시스템, 게임 오버 화면 등 핵심 시스템 구축.

## 구현 내용

### 1. 데이터 모델 (lib/data/model/)

#### item.dart
- `Item` 클래스: 아이템 속성 정의
- `ItemType` enum: weapon, armor, consumable, key
- `ItemRarity` enum: common, uncommon, rare, epic, legendary
- `InventorySlot` 클래스: 인벤토리 슬롯 (아이템 + 수량)
- `Items` 클래스: 미리 정의된 아이템 (rustyDagger, woodenShield, healthPotion 등)

#### enemy_data.dart
- `EnemyData` 클래스: 적 스탯 정의
- `EnemyType` enum: slime, goblin, skeleton, boss
- `DropEntry` 클래스: 드롭 테이블 항목
- `Enemies` 클래스: 미리 정의된 적 (slime, goblin)

#### room.dart
- `Room` 클래스: 방 정의 (크기, 문, 스폰포인트)
- `RoomType` enum: start, normal, combat, treasure, shop, rest, boss
- `DoorDirection` enum: north, south, east, west
- `Dungeon` 클래스: 던전 (방 목록 + 시작/보스 방)

### 2. 적 시스템 (lib/game/enemies/)

#### base_enemy.dart
- `BaseEnemy` 추상 클래스: 모든 적의 기본
- AI 통합, 드롭 시스템, 피격 효과, 히트스톱
- PRD 4.1 데미지 공식 적용

#### slime_enemy.dart
- `SlimeEnemy`: 슬라임 적 (통통 튀는 애니메이션)
- `GoblinEnemy`: 고블린 적

### 3. AI 시스템 (lib/game/behaviors/)

#### enemy_ai.dart
- `EnemyAI` 클래스: 상태 머신 기반 AI
- `EnemyState` enum: idle, chase, attack, dead
- 탐지 범위, 공격 범위, 쿨다운 관리

### 4. 아이템 드롭 (lib/game/decorations/)

#### dropped_item.dart
- `DroppedItem`: 바닥에 떨어진 아이템
- 반짝임/통통 튀는 애니메이션
- 플레이어 근접 시 자동 획득
- `PickupParticle`: 획득 이펙트 파티클

### 5. 상태 관리 (lib/providers/)

#### inventory_provider.dart
- `InventoryState`: 인벤토리 상태
- `InventoryNotifier`: 아이템 추가/제거, 장비 장착/해제, 골드 관리

#### game_state_provider.dart
- `GameState`: 게임 상태 (메뉴, 플레이, 일시정지, 게임오버, 승리)
- `GameStateNotifier`: 상태 전환, 점수, 통계 관리

### 6. UI (lib/ui/)

#### screens/game_over_screen.dart
- 게임 오버 화면
- 통계 표시 (층, 점수, 시간, 처치수, 아이템)
- 재시작/메인메뉴 버튼

#### screens/inventory_screen.dart
- 인벤토리 화면
- 장비 슬롯 (무기/방어구)
- 아이템 그리드
- 장착/사용/버리기 기능

#### widgets/item_slot.dart
- `ItemSlotWidget`: 아이템 슬롯 위젯
- `ItemDetailDialog`: 아이템 상세 정보 다이얼로그

### 7. 던전 생성 (lib/game/maps/)

#### dungeon_generator.dart
- `DungeonGenerator`: 절차적 던전 생성
- `RoomBuilder`: 방을 타일맵으로 변환
- 시작 방 → 일반/전투/보물/상점/휴식 방 → 보스 방

### 8. 플레이어 업데이트 (lib/game/characters/player.dart)
- `takeDamage()`: 방어력 적용 피격 처리
- `pickupItem()`: 아이템 획득 콜백
- `heal()`: 체력 회복
- `updateEquipmentStats()`: 장비 스탯 업데이트
- `reset()`: 게임 재시작용 리셋

### 9. 게임 엔진 업데이트 (lib/game/arcana_game.dart)
- 콜백 시스템 (아이템획득, 게임오버, 적처치)
- SlimeEnemy, GoblinEnemy 스폰
- 일시정지/재개/재시작 기능
- 플레이 시간 추적

## 기술적 결정

### Riverpod 상태 관리
- `StateNotifierProvider` 사용
- 인벤토리와 게임 상태 분리 관리
- Flutter UI와 Flame 게임 엔진 간 상태 동기화

### 적 AI 설계
- 간단한 상태 머신 (4 상태)
- 플레이어 탐지/추격/공격 로직
- 확장 가능한 구조

### 아이템 시스템
- 중첩 가능한 소모품
- 희귀도 기반 색상 시스템
- 드롭 테이블로 확률 관리

## 코드 품질
- `flutter analyze`: 통과 (info 레벨 1건 무시)
- 린트 규칙 준수
- 한국어 주석 포함

## 다음 단계 (Phase 3)
- 절차적 던전 생성 실제 적용
- 방 전환 시스템
- 보스 전투
- 사운드 효과
- 세이브/로드 시스템

## 파일 목록

### 신규 생성
- lib/data/model/item.dart
- lib/data/model/enemy_data.dart
- lib/data/model/room.dart
- lib/game/enemies/base_enemy.dart
- lib/game/enemies/slime_enemy.dart
- lib/game/behaviors/enemy_ai.dart
- lib/game/decorations/dropped_item.dart
- lib/game/maps/dungeon_generator.dart
- lib/providers/inventory_provider.dart
- lib/providers/game_state_provider.dart
- lib/ui/screens/game_over_screen.dart
- lib/ui/screens/inventory_screen.dart
- lib/ui/widgets/item_slot.dart

### 수정
- lib/game/characters/player.dart
- lib/game/arcana_game.dart

---
*Generated by Claude Agent Protocol v1.0*
